// TCES330 Spring 2025 University of Washington Tacoma Dr. Jie Sheng
// Rodney Deacon & Mahri Yalkapova
// 05-30-2025
// Week 8, Project Folder RegisterAlu
// // this module will implement Register and ALU operations

module RegAlu (
    input [3:0] RF_W_addr, RF_Ra_addr, RF_Rb_addr,
    input RF_W_en, Clk,
    input [2:0] ALU_s0,
    output [15:0] Q
);

    // wires / logic
    logic [15:0] A, B, W_data;

    assign W_data = Q;

  
    // instantiate reg
    RegisterFile unit_RF (Clk, RF_W_en,
                            RF_W_addr, RF_Ra_addr, RF_Rb_addr, W_data,
                            A, B);


    // instantiate alu

    ALU unit_ALU (A,B, Alu_s0); // also include params in the future


// module ALU (A,B,Sel, Q);
//    parameter bit_width = 16;
//    parameter n_op = 8; // number of operations 

//    input [ $clog2(n_op)-1 : 0 ]Sel; // the selecting bit will be ceiling log base 2 of number of operations - 1  
//    input [bit_width -1: 0]A,B;
//    output logic [bit_width -1: 0]Q;
   
// // Always comb for ALU logic

endmodule

module RegAlu_tb();

   // logic 
   logic [3:0] RF_W_addr, RF_Ra_addr, RF_Rb_addr;
   logic RF_W_en, Clk;
   logic [2:0] ALU_s0;
   logic [15:0] Q;

    logic [15:0] A, B, W_data;

   // instantiation
   /*
    input [3:0] RF_W_addr, RF_Ra_addr, RF_Rb_addr,
    input RF_W_en, Clk,
    input [2:0] ALU_s0,
    output [15:0] Q,
);
*/

   RegAlu DUT (  RF_W_addr, RF_Ra_addr, RF_Rb_addr,
   RF_W_en, Clk, ALU_s0, Q,);

   //clk
   always begin
      Clk = 0; #10;
      Clk = 1; #10;
   end


   // Testbench for RegAlu
   initial begin

      @(negedge Clk) #1;
      // enable W_wr
      RF_W_en = 1;
   // assign a data
      //   assign W_data = 47
      W_data = 16'd47;
      //    assign W_addr = R[1]
      RF_Ra_addr = 4'd1;
      //    assign RF_Ra_addr
      RF_W_addr = RF_Ra_addr; 
      // wait a clock cycle
      @(posedge Clk) #1;
      // Ra_data should be == W_data
      assert(RF_Ra_data == W_data) $dislpay("Ra_data (should be 47): %d", Ra_data);
         else $error("FAILED: got %d, expected 47", Ra_data);
      

      @(negedge Clk) #1;
      RF_W_en = 1;
   // assign b data
      //   assign W_data
      W_data = 16'd17;
      //    assign W_addr
      RF_Rb_addr = 4'd2;
      //    assign Rb_addr
      RF_W_addr = RF_Rb_addr;
      // W_addr = Rb_addr
      // wait a clock cycle
      @(posedge Clk) #1;
      // Rb_add should be == W_data
      assert(RF_Rb_data == RF_W_data) dislpay("Rb_data (should be 17): %d", Rb_data);
            else $error("FAILED: got %d, expected 17", Rb_data);

      // test add R[1] + R[2] (47 + 17)
         // set proper value for ALU for addition (3)
         ALU_s0 = 1'd3;
         // wait some time
         repeat(5) @(posedge Clk) #1;
         // ensure that Q == alu out(internal output of alu) == W_data
         assert(Q == 64) $display("yay, it worked Q == %d", Q); /// expected value
            else $error("waa waa not working Q should be 64 but it is %d", Q);
         assert((Q == DUT.unit_ALU.Q) && (Q == W_data)) $display("Works, Q = %b, W_Data = %b ", Q, W_addr);
            else $error("sadge.. it doesnt work :(");


      // test subtract R[1] - R[2] (47 - 17)
         // set proper value for ALU for subtraction (4)
         ALU_s0 = 1'd4;
         // wait some time
         repeat(5) @(posedge Clk) #1;
         // ensure that Q == alu out(internal output of alu) == W_data
         assert(Q == 30) $display("yay, it worked Q == %d", Q); /// expected value
            else $error("waa waa not working Q should be 30 but it is %d", Q);
         assert((Q == DUT.unit_ALU.Q) && (Q == W_data)) $display("Works, Q = %b, W_Data = %b ", Q, W_addr);
            else $error("sadge.. it doesnt work :(");

         // ensure that Q == alu out(internal output of alu) == W_data


   
   end

   monitor("At time %t: RegAlu outputs...", $time);

   endmodule